#!/bin/bash

# Import colors
source ~/CLI-GPT/extras/colors

# Grab current API key from gpt.py
current_key=$(grep "openai.api_key" ~/CLI-GPT/gpt.py | awk -F'"' '{print $2}')
cd /home/$USER/
rm -rf CLI-GPT/

echo -e "\n${Cyan}Welcome to the updater for CLI-GPT!${Off}\n"

# Clone into Repo
git clone https://github.com/TETRA326/CLI-GPT.git

# Install required packages
pip3 install openai
pip3 install colorama

# Give script perms
chmod +x /home/$USER/CLI-GPT/update
chmod +x /home/$USER/CLI-GPT/change-engine
chmod +x /home/$USER/CLI-GPT/tone
chmod +x /home/$USER/CLI-GPT/extras/defaults

# Ask to change key
echo -e "\n${G}API Key found in 'gpt.py'! ${Black}${On_White}($current_key)${Off}${Y}"
read -p "Do you want to change your OpenAI API key? (y/N): " update_key

if [ "$update_key" == "y" ] || [ "$update_key" == "Y" ]; then
    echo -e "${Y}"
    read -p "Please enter your OpenAI API key ('CTRL + SHIFT + V' to paste): " key
    echo -e "${Off}"
    # Replace the API key in gpt.py
    sed -i "s/openai.api_key = \"\"/openai.api_key = \"$key\"/" /home/$USER/CLI-GPT/gpt.py
    echo -e "${G}API key successfully updated in 'gpt.py'${Y}"
else
    sed -i "s/openai.api_key = \"\"/openai.api_key = \"$current_key\"/" /home/$USER/CLI-GPT/gpt.py
    echo -e "${Cyan}API Key kept!${Y}"
fi

# Ask to overwrite .bash_aliases
echo -e "\nPlease understand '~/.bash_aliases' will be overwritten! This is recommended for most users. "
read -p "Do wish to continue? (Y/n): " overwrite_aliases

if [ "$overwrite_aliases" == "n" ] || [ "$overwrite_aliases" == "N" ]; then
    echo -e "${R}NOTICE: setup will continue, but will have to execute commands manually (bash ~/CLI-GPT/gpt)!${Off}"
else
    echo -e "alias gpt='python3 ~/CLI-GPT/gpt.py'\nalias gpt-update='bash ~/CLI-GPT/update'\nalias gpt-engine='bash ~/CLI-GPT/change-engine'\nalias gpt-tone='bash ~/CLI-GPT/tone'\nalias gpt-default='bash ~/CLI-GPT/extras/defaults'" > ~/.bash_aliases
    echo -e "${G}Aliases added successfully.${Off}"
fi

# List commands
echo -e "${G}Update complete!${Off}\n"
echo -e "${B}Commands:"        
echo -e "gpt           - begin ChatGPT conversation"
echo -e "gpt-update    - update CLI-GPT code"
echo -e "gpt-tone      - change ChatGPT's tone and writing style"
echo -e "gpt-engine    - change OpenAI engine"
echo -e "gpt-default   - revert engine, tone, and writing style to defaults${Off}"
